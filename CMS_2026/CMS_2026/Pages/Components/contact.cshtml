@model CMS_2026.Data.Entities.PP_Page
@using CMS_2026.Pages
@using CMS_2026.Services
@using CMS_2026.ViewModels
@using CMS_2026.Data.Entities
@using Microsoft.Extensions.Caching.Memory
@using CMS_2026.Common
@using CMS_2026.Utils
@using Newtonsoft.Json
@inject RootService Root
@inject IDataService Db
@inject IMemoryCache Cache
@{
    var langId = Context.Request.Cookies["LangId"] ?? "vi";
    var config = Root.GetConfig(langId);
    var pageId = (int)(Context.Items["PageId"] ?? 0);
    
    // Load ContactViewModel from config
    var data = ViewHelper.LoadData<ContactViewModel>(Context, Root, Cache, key: $"{langId}-{pageId}-Contact", setup: (model) =>
    {
        if (model == null)
        {
            model = new ContactViewModel
            {
                Title = Model?.Title ?? "Liên hệ",
                MetaDescription = Model?.MetaDescription ?? config.WebDescription,
                MetaKeywords = Model?.MetaKeywords ?? ""
            };
        }
        else if (Model != null)
        {
            // Override with page data if available
            if (string.IsNullOrEmpty(model.Title)) model.Title = Model.Title;
            if (string.IsNullOrEmpty(model.MetaDescription)) model.MetaDescription = Model.MetaDescription;
            if (string.IsNullOrEmpty(model.MetaKeywords)) model.MetaKeywords = Model.MetaKeywords;
        }
        
        return model;
    });
    
    ViewData["Title"] = data?.Title ?? "Liên hệ";
    ViewData["Description"] = data?.MetaDescription ?? config.WebDescription;
    ViewData["Keywords"] = data?.MetaKeywords ?? "";
    
    var contactError = TempData.Peek("ContactError") as string;
    var contactSuccess = TempData.Peek("ContactSuccess") as string;
}

<section class="contact-section">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h2>@(data?._TitleMain ?? "Liên hệ với chúng tôi")</h2>
                @if (!string.IsNullOrEmpty(data?._ContentContact))
                {
                    <div class="mb-4">@Html.Raw(data._ContentContact)</div>
                }
                @if (!string.IsNullOrEmpty(contactError))
                {
                    <div class="alert alert-danger">@contactError</div>
                }
                @if (!string.IsNullOrEmpty(contactSuccess))
                {
                    <div class="alert alert-success">@contactSuccess</div>
                }
                <form method="post" action="/contact/submit">
                    @Html.AntiForgeryToken()
                    
                    <div class="form-group">
                        <label>Họ và tên <span class="text-danger">*</span></label>
                        <input type="text" name="Name" class="form-control" required />
                    </div>

                    <div class="form-group">
                        <label>Email <span class="text-danger">*</span></label>
                        <input type="email" name="Email" class="form-control" required />
                    </div>

                    <div class="form-group">
                        <label>Điện thoại</label>
                        <input type="tel" name="Phone" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label>Nội dung <span class="text-danger">*</span></label>
                        <textarea name="Message" class="form-control" rows="5" required></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Gửi liên hệ</button>
                </form>
            </div>
            <div class="col-md-6">
                <h3 class="fs-5 mb-6">@(langId == "en" ? "Address" : "Địa chỉ")</h3>
                @if (!string.IsNullOrEmpty(data?._Address))
                {
                    <div class="fs-6 mb-4">@Html.Raw(data._Address)</div>
                }
                else if (!string.IsNullOrEmpty(config.Company.Address))
                {
                    <div class="fs-6 mb-4">@config.Company.Address</div>
                }
                
                <h3 class="fs-5 mb-6">@(langId == "en" ? "Contact" : "Liên hệ")</h3>
                @if (!string.IsNullOrEmpty(data?._InforContact))
                {
                    <div class="fs-6 mb-4">@Html.Raw(data._InforContact)</div>
                }
                else
                {
                    <p><strong>@(langId == "en" ? "Phone" : "Điện thoại"):</strong> @config.Company.ContactPhone</p>
                    <p><strong>Email:</strong> @config.Company.Email</p>
                }
                
                <h3 class="fs-5 mb-6">@(langId == "en" ? "Hour of operation" : "Giờ làm việc")</h3>
                @if (!string.IsNullOrEmpty(data?._WorkingTime))
                {
                    <div class="fs-6">@Html.Raw(data._WorkingTime)</div>
                }
            </div>
        </div>
    </div>
</section>

