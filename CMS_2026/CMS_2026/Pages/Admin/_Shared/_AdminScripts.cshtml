@* Shared JavaScript functions for admin panel *@
<script>
    // elFinder integration - Global function for image/file picker
    function openElFinder(button) {
        var targetId = $(button).attr('target');
        if (!targetId) {
            console.error('openElFinder: target attribute not found');
            return;
        }
        
        // Create callback function for this target
        window["elfinder_callback_" + targetId] = function (files) {
            if (files && files.length > 0) {
                var file = files[0];
                var url = file.url || file.path;
                
                if (url) {
                    // Handle both absolute and relative URLs
                    if (url.startsWith('http://') || url.startsWith('https://')) {
                        var urlObj = new URL(url);
                        url = urlObj.pathname;
                    }
                    
                    $('#' + targetId).val(url);
                    
                    // Update image preview if exists
                    var imgElement = $('#img-' + targetId);
                    if (imgElement.length) {
                        imgElement.attr("src", url);
                    }
                }
            }
        };
        
        // Open elFinder in popup
        var popupUrl = '/admin/elfinder/elfinder.html?target=' + encodeURIComponent(targetId);
        var popup = window.open(popupUrl, 'elFinder', 'width=900,height=600,resizable=yes,scrollbars=yes');
        
        // Store callback in window for popup to access
        window.addEventListener('message', function(event) {
            if (event.data && event.data.command === 'elfinder-select' && event.data.target === targetId) {
                window["elfinder_callback_" + targetId](event.data.files);
                popup.close();
            }
        });
    }

    // Initialize elFinder event handlers for dynamically added elements
    $(document).on('click', '.btn-ckfinder-popup, .btn-elfinder-popup', function (e) {
        e.preventDefault();
        openElFinder(this);
    });
</script>

