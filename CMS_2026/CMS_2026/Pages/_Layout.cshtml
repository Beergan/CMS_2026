@using CMS_2026.Services
@inject RootService Root
@{
    var langId = Context.Request.Cookies["LangId"] ?? "vi";
    var config = Root.GetConfig(langId);
}

<!DOCTYPE html>
<html lang="vi" class="loading-site no-js">
<head>
    <base href="/" />
    <meta charset="utf-8">
    <title>@(ViewData["Title"] != null ? ViewData["Title"] + " - " : string.Empty)@config.WebTitle</title>
    <meta name="description" content="@(ViewData["Description"] ?? config.WebDescription)">
    <meta name="keywords" content="@(ViewData["Keywords"] ?? "")">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="canonical" href="@(Context.Request.Scheme)://@(Context.Request.Host)@(Context.Request.Path)" />
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <link rel="icon" href="@config.Favicon" type="image/x-icon" />

    <meta property="og:type" content="website">
    <meta property="og:title" content="@(ViewData["Title"] ?? config.WebTitle)">
    <meta property="og:description" content="@(ViewData["Description"] ?? config.WebDescription)">
    <meta property="og:url" content="@(Context.Request.Scheme)://@(Context.Request.Host)@(Context.Request.Path)">
    <meta property="og:image" content="@(ViewData["Image"] ?? config.Favicon)">
    <meta property="og:site_name" content="@config.WebTitle">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="@(ViewData["Title"] ?? config.WebTitle)">
    <meta name="twitter:description" content="@(ViewData["Description"] ?? config.WebDescription)">
    <meta name="twitter:image" content="@(ViewData["Image"] ?? config.Favicon)">

    <link rel="icon" href="@config.Favicon" sizes="32x32">
    <link rel="icon" href="@config.Favicon" sizes="192x192">

    <link rel="stylesheet" href="assets/vendors/lightgallery/css/lightgallery-bundle.min.css">
    <link rel="stylesheet" href="assets/vendors/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="assets/vendors/animate/animate.min.css">
    <link rel="stylesheet" href="assets/vendors/slick/slick.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    @await RenderSectionAsync("head", required: false)
</head>
<body>
    @await Html.PartialAsync("_Header", config)
    
    <main>
        @RenderBody()
    </main>

    @await Html.PartialAsync("_Footer", config)

    @* Cart Sidebar Offcanvas *@
    <div class="offcanvas offcanvas-end" tabindex="-1" id="shoppingCart" aria-labelledby="shoppingCartLabel">
        <div class="sidebar-cart-active">
            @await Html.PartialAsync("Components/layout_sidebar", (CMS_2026.Data.Entities.PP_Page?)null)
        </div>
    </div>

    <script src="assets/vendors/jquery/jquery.min.js"></script>
    <script src="assets/vendors/bootstrap/js/bootstrap.bundle.js"></script>
    <script src="assets/vendors/clipboard/clipboard.min.js"></script>
    <script src="assets/vendors/vanilla-lazyload/lazyload.min.js"></script>
    <script src="assets/vendors/waypoints/jquery.waypoints.min.js"></script>
    <script src="assets/vendors/lightgallery/lightgallery.min.js"></script>
    <script src="assets/vendors/lightgallery/plugins/zoom/lg-zoom.min.js"></script>
    <script src="assets/vendors/lightgallery/plugins/thumbnail/lg-thumbnail.min.js"></script>
    <script src="assets/vendors/lightgallery/plugins/video/lg-video.min.js"></script>
    <script src="assets/vendors/isotope/isotope.pkgd.min.js"></script>
    <script src="assets/vendors/slick/slick.min.js"></script>
    <script src="assets/vendors/gsap/gsap.min.js"></script>
    <script src="assets/vendors/gsap/ScrollToPlugin.min.js"></script>
    <script src="assets/vendors/gsap/ScrollTrigger.min.js"></script>
    <script src="assets/js/theme.min.js"></script>
    <script src="assets/js/men.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <script>
        $(document).ready(function () {
            // Quantity adjustment
            $(document).on('click', '.ju-qty-adjust-plus', function (e) {
                e.preventDefault();
                var $input = $(this).siblings('.js-qty-num');
                var currentVal = parseInt($input.val()) || 0;
                var maxVal = parseInt($input.attr('max')) || 999;
                if (currentVal < maxVal) {
                    $input.val(currentVal + 1);
                    $input.trigger('change');
                }
            });
            
            $(document).on('click', '.ju-qty-adjust-minus', function (e) {
                e.preventDefault();
                var $input = $(this).siblings('.js-qty-num');
                var currentVal = parseInt($input.val()) || 0;
                if (currentVal > 1) {
                    $input.val(currentVal - 1);
                    $input.trigger('change');
                }
            });
            
            // Cart update
            $(document).on('click', '.js-qty-adjust', function () {
                var cart_item = $(this).parents(".sidebar-item");
                var productId = $(this).parents(".sidebar-item").attr("data-product-id");
                var variation = $(this).parents(".sidebar-item").attr("data-product-variation");
                var quantity = $(cart_item).find("input[name='quantitycart']").val();
                
                $.post("/Api/Cart/Update", {
                    productId: productId,
                    variation: variation,
                    quantity: quantity
                }, function (data) {
                    if (data.success) {
                        // Reload cart sidebar
                        location.reload();
                    }
                }).fail(function () {
                    Toastify({
                        text: "Giỏ hàng chưa được cập nhật!",
                        duration: 3000,
                        gravity: "bottom",
                        position: "center",
                        backgroundColor: "#f44336",
                        stopOnFocus: true,
                    }).showToast();
                });
            });
        });
    </script>
    
    <script>
        // Add to cart
        $(document).on("click", ".action-cart-add", function (e) {
            e.preventDefault();
            var productId = $(this).attr("data-product-id");
            if (!productId) return;
            
            $.post("/Api/Cart/Add", { productId: productId }, function (data) {
                if (data.success) {
                    // Update cart count badge
                    $(".cart-count").text(data.cartCount);
                    $(".amount .badge").text(data.cartCount);
                    // Reload cart sidebar if exists
                    if ($(".sidebar-cart-active").length) {
                        location.reload();
                    }
                    Toastify({
                        text: data.message || "Giỏ hàng đã được cập nhật!",
                        duration: 3000,
                        gravity: "bottom",
                        position: "center",
                        backgroundColor: "#4caf50",
                        stopOnFocus: true,
                    }).showToast();
                } else {
                    Toastify({
                        text: data.message || "Có lỗi xảy ra!",
                        duration: 3000,
                        gravity: "bottom",
                        position: "center",
                        backgroundColor: "#f44336",
                        stopOnFocus: true,
                    }).showToast();
                }
            }).fail(function () {
                Toastify({
                    text: "Giỏ hàng chưa được cập nhật!",
                    duration: 3000,
                    gravity: "bottom",
                    position: "center",
                    backgroundColor: "#f44336",
                    stopOnFocus: true,
                }).showToast();
            });
        });
        
        // Add to cart with variation
        $(document).on("click", ".product-action-cart-variation .dropdown-menu a", function (e) {
            e.preventDefault();
            var button = $(this).closest(".product-action-cart-variation").find("button");
            var productId = $(this).data("product-id");
            var variation = $(this).text();
            
            if (!productId) return;
            var originalText = $(button).text();
            $(button).text("Đang xử lý..");
            
            $.post("/Api/Cart/Add", {
                productId: productId,
                variation: variation
            }, function (data) {
                if (data.success) {
                    $(".cart-count").text(data.cartCount);
                    $(".amount .badge").text(data.cartCount);
                    if ($(".sidebar-cart-active").length) {
                        location.reload();
                    }
                    $(button).text("Đã thêm!");
                    setTimeout(() => $(button).text(originalText), 2000);
                    Toastify({
                        text: data.message || "Giỏ hàng đã được cập nhật!",
                        duration: 3000,
                        gravity: "bottom",
                        position: "center",
                        backgroundColor: "#4caf50",
                        stopOnFocus: true,
                    }).showToast();
                } else {
                    $(button).text(originalText);
                    Toastify({
                        text: data.message || "Có lỗi xảy ra!",
                        duration: 3000,
                        gravity: "bottom",
                        position: "center",
                        backgroundColor: "#f44336",
                        stopOnFocus: true,
                    }).showToast();
                }
            }).fail(function () {
                $(button).text(originalText);
                Toastify({
                    text: "Giỏ hàng chưa được cập nhật!",
                    duration: 3000,
                    gravity: "bottom",
                    position: "center",
                    backgroundColor: "#f44336",
                    stopOnFocus: true,
                }).showToast();
            });
        });
        
        // Remove from cart
        $(document).on("click", ".cart-delete", function () {
            var productId = $(this).attr("data-product-id");
            var variation = $(this).attr("data-variation-id");
            var product = $(this).closest(".cart-item");
            product.addClass("loading");
            
            $.post("/Api/Cart/Remove", {
                productId: productId,
                variation: variation
            }, function (data) {
                if (data.success) {
                    product.remove();
                    $(".cart-count").text(data.cartCount);
                    $(".amount .badge").text(data.cartCount);
                    // Reload cart sidebar if exists
                    if ($(".sidebar-cart-active").length) {
                        location.reload();
                    }
                    Toastify({
                        text: data.message || "Đã xóa khỏi giỏ hàng!",
                        duration: 3000,
                        gravity: "bottom",
                        position: "center",
                        backgroundColor: "#4caf50",
                        stopOnFocus: true,
                    }).showToast();
                } else {
                    product.removeClass("loading");
                    Toastify({
                        text: data.message || "Có lỗi xảy ra!",
                        duration: 3000,
                        gravity: "bottom",
                        position: "center",
                        backgroundColor: "#f44336",
                        stopOnFocus: true,
                    }).showToast();
                }
            }).fail(function () {
                product.removeClass("loading");
                Toastify({
                    text: "Có lỗi xảy ra!",
                    duration: 3000,
                    gravity: "bottom",
                    position: "center",
                    backgroundColor: "#f44336",
                    stopOnFocus: true,
                }).showToast();
            });
        });
    </script>
    
    <script>
        // Back to top button
        $(document).ready(function() {
            $(window).scroll(function() {
                if ($(this).scrollTop() > 100) {
                    $('.gtf-back-to-top').fadeIn();
                } else {
                    $('.gtf-back-to-top').fadeOut();
                }
            });
            
            $('.gtf-back-to-top').click(function(e) {
                e.preventDefault();
                $('html, body').animate({scrollTop: 0}, 600);
                return false;
            });
        });
    </script>
    
    @await RenderSectionAsync("scripts", required: false)
</body>
</html>

